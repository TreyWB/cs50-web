{% extends "auctions/layout.html" %}

{% block body %}
    <div class="listing-info">
        <h2>{{ listing.title }}</h2>

        {% if not listing.is_active %}
        <h4>Winner: {{ winner.user }}</h4>
        {% endif %}

        <p>Category: {{ listing.category }}</p>
        <p>Posted By: <a href="{% url 'user_listings' listing.user.id %}">{{ listing.user }}</a></p>

        {% if listing.photo_url %}
        <img src="{{ listing.photo_url }}">
        {% endif %}

        <p>${{ listing.get_current_bid|floatformat:2 }}</p>
        <p>Status: {{ listing.is_active|yesno:"Active,Closed" }}</p>

        <br>

        <p>{{ listing.description }}</p>

    </div>

    {% if listing.is_active and listing.user_id != user.id %}

    <div class="bid-form">
        <form action="{% url 'new_bid' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="listing_id" value="{{ listing.id }}">
            <input type="number" step="0.01" name="bid" placeholder="Enter your bid" required>

            <button type="submit">Place Bid</button>
        </form>
    </div>

    {% endif %}

    <div class="buttons">

        {% if user.is_authenticated and listing.user_id == user.id %}
        <div id="edit">
            <form action="{% url 'edit_listing' listing.id %}" method="GET">
                {% csrf_token %}
                <input type="submit" value="Edit Listing">
            </form>
        </div>

        {% endif %}
        <br>

        {% if listing.is_active and listing.user_id == user.id %}
            <div id="close-listing">
                <form action="{% url 'close_listing' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="listing_id" value="{{ listing.id }}">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="submit" value="Close Listing">
                </form>
            </div>
        {% endif %}

        {% if not listing.is_active and user.id == listing.user_id %}
            <div id="reopen-listing">
                <form action="{% url 'reopen_listing' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="listing_id" value="{{ listing.id }}">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="submit" value="Reopen Listing">
                </form>
            </div>
        {% endif %}

        {% if is_watched %}

        <div id="watchlist"></div>
            <form action="{% url 'watchlist_removed' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                <input type="submit" value="Remove from Watchlist">
                <p>{{ listing.watchlist_count }}</p>
            </form>
        </div>

        {% else %}

        <div id="watchlist">
            <form action="{% url 'watchlist_added' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                <input type="submit" value="Add to Watchlist">
                <p>{{ listing.watchlist_count }}</p>
            </form>
        </div>

        {% endif %}

    </div>

    <div class="comment-section">
        <h5>Comments ({{ comment_count }})</h5>

        <p class="d-inline-flex gap-1">
            <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
              Add a Comment
            </button>
        </p>
        <div class="collapse" id="collapseExample">
            <form action="{% url 'add_comment' listing.id %}" method="POST">
                {% csrf_token %}
                <textarea name="comment" placeholder="Add a comment" rows="4" cols="50"></textarea>
                <br>
                <input type="submit" value="Add Comment">
            </form>
        </div>

        <hr>

        {% if comments %}
            {% for comment in comments %}
                <div class="comment">
                    <p>{{ comment.user }} * {{ comment.posted_date }}</p>
                    <p>{{ comment.comment }}</p>
                </div>

            {% endfor %}
        {% else %}
            <p>No comments yet.</p>
        {% endif %}



    </div>
{% endblock %}